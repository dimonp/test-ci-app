name: Test

on:
  pull_request:
  release:
    types: [ published ]
  push:
    branches: [ main, develop, master ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}

    permissions:
      actions: read
      contents: write
      security-events: write

    strategy:
      fail-fast: false

      matrix:
        os:
          - ubuntu-latest
          - windows-latest

        compiler:
          - llvm-19.1.1
          - gcc-14

        generator:
          - "Ninja Multi-Config"

        build_type:
          - Release
          - Debug

        build_shared:
          - OFF

        exclude:
          - os: windows-latest
            compiler: gcc-14

          - os: windows-latest
            compiler: llvm-19.1.1

        include:

          # Inject GCOV variable for gcc
          - compiler: gcc-14
            gcov_executable: gcov-14
            enable_ipo: On

          # Inject GCOV variable for llvm
          - compiler: llvm-19.1.1
            gcov_executable: "llvm-cov gcov"
            enable_ipo: On

          - build_type: Release
            preset: conan-release

          - build_type: Debug
            preset: conan-debug

          - os: windows-latest
            compiler: msvc
            generator: "Visual Studio 17 2022"
            build_type: Debug
            preset: conan-default
            enable_ipo: On

          - os: windows-latest
            compiler: msvc
            generator: "Visual Studio 17 2022"
            build_type: Release
            preset: conan-default
            enable_ipo: On

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: 'recursive' # Useful if vcpkg is a submodule

    - name: Setup Cache
      uses: ./.github/actions/setup_cache
      with:
        compiler: ${{ matrix.compiler }}
        build_type: ${{ matrix.build_type }}
        packaging_maintainer_mode: ${{ matrix.packaging_maintainer_mode }}
        generator: ${{ matrix.generator }}

    - name: Project Name
      uses: cardinalby/export-env-action@v2
      with:
        envFile: '.github/constants.env'

    - name: Setup C++ environment (optional, but helpful for pre-installed tools)
      # This marketplace action can set up compiler, cmake, ninja, and vcpkg
      uses: aminya/setup-cpp@v1
      with:
        compiler: ${{ matrix.compiler }}
        vcvarsall: ${{ contains(matrix.os, 'windows' )}}
        cmake: true
        ninja: true
        conan: true
        ccache: true
        cppcheck: true
        gcovr: true
        opencppcoverage: true

    - name: Detects and creates the default profile
      run: conan profile detect --force

    - name: Install project dependencies
      working-directory: ${{ github.workspace }}
      run: conan install . -s build_type=${{ matrix.build_type }} --build=missing -o build_subfolder=${{ matrix.build_type }}

    - name: Configure CMake
      run: >
        cmake -B "${{ github.workspace }}/build/${{ matrix.build_type }}"
        -S "${{ github.workspace }}"
        -G "${{ matrix.generator }}"
        -DCMAKE_BUILD_TYPE:STRING=${{ matrix.build_type }}
        -D${{ env.PROJECT_NAME }}_PACKAGING_MAINTAINER_MODE:BOOL=${{ matrix.packaging_maintainer_mode }}
        -D${{ env.PROJECT_NAME }}_ENABLE_COVERAGE:BOOL=${{ matrix.build_type == 'Debug' }}
        --preset ${{ matrix.preset }}

    - name: Build project
      working-directory: ${{ github.workspace }}
      run: cmake --build "${{ github.workspace }}/build/${{ matrix.build_type }}" --config ${{ matrix.build_type }}

    - name: Unix - Test and coverage
      if: runner.os != 'Windows'
      working-directory: ./build/${{ matrix.build_type }}
      run: |
        ctest -C ${{ matrix.build_type }}
        gcovr -j ${{ env.nproc }} --root ../../ --print-summary --xml-pretty --xml coverage.xml . --gcov-executable '${{ matrix.gcov_executable }}'

    - name: Windows - Test and coverage
      if: runner.os == 'Windows'
      working-directory: ./build/${{ matrix.build_type }}
      run: |
        OpenCppCoverage.exe --export_type cobertura:coverage.xml --cover_children -- ctest -C ${{ matrix.build_type }}

    - name: Simple Badge Generator
      uses: cjlapao/simple-badge-generator-action@v1.0.1
      with:
        badge-path: "./build/coverage/coverage.svg"
        badge-type: "cobertura"
        title: "Coverage"
        cobertura-path: "./build/${{ matrix.build_type }}/coverage.xml"

    - name: Publish coverage report to GitHub Pages
      # upload the report only once
      if: |
        startsWith(matrix.os, 'ubuntu') &&
        startsWith(matrix.compiler, 'gcc') &&
        matrix.build_type == 'Debug'
      uses: JamesIves/github-pages-deploy-action@v4.8.0
      with:
        folder: ./build/coverage/
        branch: gh-pages
        target-folder: coverage/
